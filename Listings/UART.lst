C51 COMPILER V9.60.0.0   UART                                                              09/25/2023 09:39:22 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN .\Objects\UART.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE UART.c OPTIMIZE(0,SIZE) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\UART.
                    -lst) TABS(2) OBJECT(.\Objects\UART.obj)

line level    source

   1          #include "main.h"
   2          
   3          bit busy;
   4          char wptr;
   5          char rptr;
   6          char buffer[16];
   7          
   8          bit UartOnMsg = 0;
   9          char code *STCISPCMD = "@STCISP#";
  10          char ISP_INDEX;
  11          
  12          void UartIsr() interrupt 4
  13          {
  14   1          if (TI)
  15   1          {
  16   2              TI = 0;
  17   2              busy = 0;
  18   2          }
  19   1          if (RI)
  20   1          {
  21   2              RI = 0;
  22   2              buffer[wptr++] = SBUF;
  23   2              wptr &= 0x0f;
  24   2              if (SBUF == STCISPCMD[ISP_INDEX])
  25   2              {
  26   3                  ISP_INDEX++;
  27   3                  if (STCISPCMD[ISP_INDEX] == '\0')
  28   3                      IAP_CONTR = 0x60;
  29   3              } else {
  30   3                  ISP_INDEX = 0;
  31   3                  if (SBUF == STCISPCMD[ISP_INDEX])
  32   3                      ISP_INDEX++;
  33   3              }
  34   2              if(wptr > 16) 
  35   2              {
  36   3                //UartSendErr();
  37   3                wptr = 0; //clear
  38   3              }
  39   2              else if(SBUF == 0x0A) 
  40   2              {
  41   3                buffer[wptr++] = '\0';
  42   3                wptr = 0;
  43   3                UartOnMsg = 1;
  44   3              }
  45   2          }
  46   1      }
  47          
  48          void UartOnMessage(void)
  49          {
  50   1        UartSendStr(buffer);
  51   1        UartSendOK();
  52   1        UartOnMsg = 0;
  53   1      }
  54          
C51 COMPILER V9.60.0.0   UART                                                              09/25/2023 09:39:22 PAGE 2   

  55          void UartInit()
  56          {
  57   1          P_SW2 |= 0x80;
  58   1          SCON = 0x50;
  59   1          TMOD = 0x00;
  60   1          TL1 = BRT;
  61   1          TH1 = BRT >> 8;
  62   1          TR1 = 1;
  63   1          AUXR = 0x40;
  64   1          wptr = 0x00;
  65   1          rptr = 0x00;
  66   1          busy = 0;
  67   1          ES = 1;
  68   1          EA = 1;
  69   1          UartSendOK();
  70   1          P_SW2 &= ~0x80;
  71   1      }
  72          
  73          void UartSend(char dat)
  74          {
  75   1          while (busy);
  76   1          busy = 1;
  77   1          SBUF = dat;
  78   1      }
  79          
  80          char putchar(char ch)
  81          {
  82   1          SBUF = ch;
  83   1          while(TI == 0);
  84   1          TI = 0;
  85   1          return ch;
  86   1      }
  87          
  88          void UartSendStr(char *p)
  89          {
  90   1          while (*p != '\0')
  91   1          {
  92   2              UartSend(*p++);
  93   2          }
  94   1      }
  95          
  96          //void UartSendErr(void)
  97          //{
  98          //    UartSendStr("Error\r\n");
  99          //}
 100          
 101          void UartSendOK(void)
 102          {
 103   1          UartSendStr("OK\r\n");
 104   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    349    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     26    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
